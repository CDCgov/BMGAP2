name: CI

on:
    push:
        branches:
            - main
            - lskatz-qsub-array
    pull_request:
        branches:
            - main

env:
    # increment this number if you want to rebuild the cache
    cache-build-number: 3
    cache-pixi-path: ${{ github.workspace }}/.pixi
    cache-hg-path: ${{ github.workspace }}/analysis_scripts/hg38

jobs:
    build:
        runs-on: ubuntu-22.04
        strategy:
            matrix:
                SRR: [SRR8034137]
        steps:
            - name: Checkout code
              uses: actions/checkout@v2
            - name: install pixi and update BMGAP environment
              run: |
                curl -fsSL https://pixi.sh/install.sh | sh
                echo "$HOME/.pixi/bin" >> $GITHUB_PATH
                echo "$GITHUB_WORKSPACE/analysis_scripts" >> $GITHUB_PATH
                sudo apt-get install -y tree
            - name: cache-pixi-env
              id: cache-pixi-env
              uses: actions/cache@v4
              with:
                path: |
                  #$GITHUB_WORKSPACE/.pixi
                  ${{ github.workspace }}/pixi.toml
                  ${{ github.workspace }}/.pixi
                key: ${{ runner.os }}-pixi-${{ hashFiles('BMGAP_Conda_all.yml') }}-${{ env.cache-build-number }}
            
            - name: Set up pixi env
              if: steps.cache-pixi-env.outputs.cache-hit != 'true'
              run: |
                  pixi init --import BMGAP_Conda_all.yml
                  pixi add awscli sra-tools
                  pixi --verbose --verbose install
            
            - name: cache-SRR
              id: cache-SRR
              uses: actions/cache@v4
              with:
                path: test.in/${{ matrix.SRR }}
                key: ${{ runner.os }}-SRR-${{ matrix.SRR }}-${{ hashFiles('BMGAP_Conda_all.yml') }}-${{ env.cache-build-number }}
            - name: download test data
              if: steps.cache-SRR.outputs.cache-hit != 'true'
              run: |
                  mkdir -pv test.in/${{ matrix.SRR }}
                  pixi run fasterq-dump ${{ matrix.SRR }} --threads 1 --outdir test.in/${{ matrix.SRR }} --split-files --skip-technical
                  gzip -v test.in/${{matrix.SRR }}/*.fastq
                  mv -v test.in/${{ matrix.SRR }}/${{ matrix.SRR }}_1.fastq.gz test.in/${{ matrix.SRR }}/${{ matrix.SRR }}_R1.fastq.gz
                  mv -v test.in/${{ matrix.SRR }}/${{ matrix.SRR }}_2.fastq.gz test.in/${{ matrix.SRR }}/${{ matrix.SRR }}_R2.fastq.gz
                            
            - name: cache-human-genome
              id: cache-human-genome
              uses: actions/cache@v4
              with:
                path: |
                  ${{ env.cache-hg-path }}
                key: ${{ runner.os }}-hg38-${{ hashFiles('BMGAP_Conda_all.yml') }}-${{ matrix.SRR }}-${{ env.cache-build-number }}
            
            - name: download human genome
              if: steps.cache-human-genome.outputs.cache-hit != 'true'
              run: |
                  aws s3 --no-sign-request --region eu-west-1 sync s3://ngi-igenomes/igenomes/Homo_sapiens/NCBI/GRCh38/Sequence/Bowtie2Index/ ${{ env.cache-hg-path }}
            - name: view environment
              run: |
                tree $GITHUB_WORKSPACE
                echo "======="
                tree ${{ env.cache-hg-path}}

            # Cache the first test just because it takes so long.
            # The cache key depends on the hash of Alignment.sh to ensure that
            # it refreshes the cache if the script changes at all.
            - name: cache-alignment
              id: cache-alignment
              uses: actions/cache@v4
              with:
                path: |
                  ${{ github.workspace }}/out/${{ matrix.SRR }}/${{ matrix.SRR }}_SPAdes
                  ${{ github.workspace }}/${{ matrix.SRR }}_R1_dedup*.fastq.gz
                key: ${{ runner.os }}-alignment-${{ matrix.SRR }}-${{ hashFiles('BMGAP_Conda_all.yml') }}-${{ hashFiles('analysis_scripts/Alignment.sh') }}-${{ env.cache-build-number }}
            - name: test-alignment
              if: steps.cache-alignment.outputs.cache-hit != 'true'
              env:
                NSLOTS: 2
                ANALYSIS_SCRIPTS: ${{ github.workspace }}/analysis_scripts
              run: |
                mkdir -v $GITHUB_WORKSPACE/out
                pixi run bash $ANALYSIS_SCRIPTS/Alignment.sh test.in/${{ matrix.SRR }}/${{ matrix.SRR }}_R1.fastq.gz test.in/${{ matrix.SRR }}/${{ matrix.SRR }}_R2.fastq.gz $GITHUB_WORKSPACE/out ${{ matrix.SRR }}
            
            - name: test-cleanup
              env:
                NSLOTS: 2
                ANALYSIS_SCRIPTS: ${{ github.workspace }}/analysis_scripts
              run: |
                pixi run bash $ANALYSIS_SCRIPTS/cleanupSingle.sh $GITHUB_WORKSPACE/out ${{ matrix.SRR }}
            - name: test-bmscan
              env:
                NSLOTS: 2
                ANALYSIS_SCRIPTS: ${{ github.workspace }}/analysis_scripts
              run: |
                pixi run bash $ANALYSIS_SCRIPTS/BMScan.sh $GITHUB_WORKSPACE/out ${{ matrix.SRR }}
            - name: test-pmga
              env:
                NSLOTS: 2
                ANALYSIS_SCRIPTS: ${{ github.workspace }}/analysis_scripts
              run: |
                pixi run bash $ANALYSIS_SCRIPTS/PMGA.sh $GITHUB_WORKSPACE/out ${{ matrix.SRR }}
            - name: test-locusextractor
              env:
                NSLOTS: 2
                ANALYSIS_SCRIPTS: ${{ github.workspace }}/analysis_scripts
              run: |
                pixi run bash $ANALYSIS_SCRIPTS/LocusExtractor.sh $GITHUB_WORKSPACE/out ${{ matrix.SRR }}
            - name: test-amr
              env:
                NSLOTS: 2
                ANALYSIS_SCRIPTS: ${{ github.workspace }}/analysis_scripts
              run: |
                pixi run bash $ANALYSIS_SCRIPTS/AMR.sh $GITHUB_WORKSPACE/out ${{ matrix.SRR }}
            - name: check final output
              run: |
                echo "Checking output"
                tree $GITHUB_WORKSPACE/out
                echo
                ls -lhRA $GITHUB_WORKSPACE/out